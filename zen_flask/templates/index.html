<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Echo</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+JP:wght@300;400&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
</head>
<body>
    <div class="container">
        <header>
            <h1>Echo</h1>
            <button id="theme-toggle"><i class="fas fa-moon"></i></button>
        </header>
        <main>
            <section class="zen-content">
                <p id="zen-quote">Empty your mind, be formless, shapeless — like water.</p>
                <div class="meditation-circle" id="breathing-circle"></div>
            </section>
        </main>
        <div class="chat-window">
            <div id="chat-display" class="chat-display"></div>
        </div>
        <footer>
            <p>Breathe in peace, breathe out stress</p>
        </footer>
    </div>
    <div class="ai-interaction">
        <input type="text" id="user-input" placeholder="Type your message...">
        <button id="send-button">Send</button>
        <button id="mic-button" title="Speak" style="margin-left:10px;"><i class="fas fa-microphone"></i></button>
    </div>
    <script>
        const themeToggle = document.getElementById('theme-toggle');
        const body = document.body;

        themeToggle.addEventListener('click', () => {
            body.classList.toggle('dark-theme');
            const icon = themeToggle.querySelector('i');
            if (body.classList.contains('dark-theme')) {
                icon.classList.remove('fa-moon');
                icon.classList.add('fa-sun');
            } else {
                icon.classList.remove('fa-sun');
                icon.classList.add('fa-moon');
            }
        });

        const userInput = document.getElementById('user-input');
        const sendButton = document.getElementById('send-button');
        const chatDisplay = document.getElementById('chat-display');

        // Function to append messages to the chat display
        function appendMessage(sender, message, type) {
            const messageElement = document.createElement('div');
            messageElement.classList.add('chat-message', `${type}-message`);
            messageElement.textContent = message;
            chatDisplay.appendChild(messageElement);
            chatDisplay.scrollTop = chatDisplay.scrollHeight; // Auto-scroll to bottom
        }

        // Event listener for the send button
        sendButton.addEventListener('click', async () => {
            const userMessage = messageInput.value.trim();
            if (userMessage) {
                appendMessage('You', userMessage, 'user');
                messageInput.value = ''; // Clear input

                try {
                    const response = await fetch('/chat', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ message: userMessage }),
                    });

                    if (response.ok) {
                        const data = await response.json();
                        appendMessage('AI', data.response, 'ai');
                    } else {
                        appendMessage('System', 'Error: Could not get response from AI.', 'system');
                        console.error('Error:', response.statusText);
                    }
                } catch (error) {
                    appendMessage('System', 'Error: Network or server issue.', 'system');
                    console.error('Fetch error:', error);
                }
            }
        });

        // Allow sending message with Enter key
        messageInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                sendButton.click();
            }
        });

        // Initial system message
        appendMessage('System', 'Welcome to the AI Chat. Type your message below!', 'system');

        // QUOTE CYCLING LOGIC
        const quotes = [
            "Empty your mind, be formless, shapeless — like water.",
            "The mind is everything. What you think you become.",
            "Peace comes from within. Do not seek it without.",
            "Breathe in calm, breathe out tension.",
            "Let go of what you cannot control."
        ];
        let quoteIdx = 0;
        const zenQuote = document.getElementById('zen-quote');
        setInterval(() => {
            quoteIdx = (quoteIdx + 1) % quotes.length;
            zenQuote.textContent = quotes[quoteIdx];
        }, 4000);
        // Speech-to-Text integration
        const micButton = document.getElementById('mic-button');
        let mediaRecorder;
        let audioChunks = [];
    
        micButton.addEventListener('click', async () => {
            if (!mediaRecorder || mediaRecorder.state === 'inactive') {
                // Request microphone access
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    mediaRecorder = new MediaRecorder(stream);
                    audioChunks = [];
                    mediaRecorder.ondataavailable = event => {
                        audioChunks.push(event.data);
                    };
                    mediaRecorder.onstop = async () => {
                        const audioBlob = new Blob(audioChunks, { type: 'audio/wav' });
                        const formData = new FormData();
                        formData.append('audio', audioBlob);
                        // Send audio to backend for transcription
                        const response = await fetch('/speech-to-text', {
                            method: 'POST',
                            body: formData
                        });
                        const data = await response.json();
                        if (data.transcript) {
                            document.getElementById('user-input').value = data.transcript;
                        }
                    };
                    mediaRecorder.start();
                    micButton.classList.add('recording');
                    setTimeout(() => {
                        mediaRecorder.stop();
                        micButton.classList.remove('recording');
                    }, 4000); // Record for 4 seconds
                } catch (err) {
                    alert('Microphone access denied or unavailable.');
                }
            }
        });
    </script>
</body>
</html>